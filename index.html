<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flashcards with Input</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold mb-4">Flashcards with Input</h1>

    <!-- Add / Import / Export -->
    <div class="bg-white p-4 rounded-xl shadow mb-6">
      <h2 class="font-semibold mb-2">Add a Card</h2>
      <input id="front" class="w-full border rounded p-2 mb-2" placeholder="Front (犬)">
      <input id="back" class="w-full border rounded p-2 mb-2" placeholder="Back (いぬ; dog)">
      <label class="flex items-center gap-2 mb-2 text-sm">
        <input type="checkbox" id="reverse" checked> Also create reverse card
      </label>
      <div class="flex gap-2">
        <button onclick="addCard()" class="px-4 py-2 rounded bg-black text-white">Add</button>
        <label class="px-4 py-2 rounded bg-gray-100 border cursor-pointer">
          Import JSON
          <input type="file" accept="application/json" class="hidden" onchange="importFromFile(event)">
        </label>
        <button onclick="exportJSON()" class="px-4 py-2 rounded bg-gray-900 text-white">Export JSON</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">
        JSON format: <code>[{"front":"犬","back":"いぬ; dog"},{"front":"猫","back":"ねこ; cat"}]</code>
      </p>
    </div>

    <!-- Review -->
    <div class="bg-white p-4 rounded-xl shadow mb-6">
      <div class="flex items-center gap-3 mb-3">
        <span class="text-sm">Direction:</span>
        <select id="mode" class="border rounded px-2 py-1 text-sm">
          <option value="front">Front → Back</option>
          <option value="back">Back → Front</option>
          <option value="mixed">Mixed</option>
        </select>
        <button onclick="startReview()" class="ml-auto px-4 py-2 rounded bg-black text-white">Start / Shuffle</button>
      </div>
      <div id="cardArea" class="hidden">
        <div id="prompt" class="text-2xl font-semibold mb-3"></div>
        <input id="answerInput" class="w-full border rounded p-2 mb-2" placeholder="Type your answer... (Enter = Check / Next)">
        <div id="result" class="mt-3"></div>
      </div>
    </div>

    <!-- Card List -->
    <div class="bg-white p-4 rounded-xl shadow">
      <h2 class="font-semibold mb-2">Your Cards</h2>
      <ul id="cardList" class="text-sm space-y-1"></ul>
    </div>
  </div>

<script>
let cards = JSON.parse(localStorage.getItem("cards") || "[]");
// If no cards exist in localStorage, auto-load kanken10.json
if (!localStorage.getItem("cards")) {
  fetch("kanken10.json")
    .then(res => res.json())
    .then(data => {
      cards = data;
      save();
      renderList();
    })
    .catch(err => console.error("Error loading default deck:", err));
}
let queue = [];
let current = null;
let currentSide = "front";
let lastChecked = false; // track if current card already checked

function save() {
  localStorage.setItem("cards", JSON.stringify(cards));
  renderList();
}

function addCard() {
  const f = document.getElementById("front").value.trim();
  const b = document.getElementById("back").value.trim();
  const rev = document.getElementById("reverse").checked;
  if (!f || !b) return;
  cards.push({ front: f, back: b });
  if (rev) cards.push({ front: b, back: f });
  document.getElementById("front").value = "";
  document.getElementById("back").value = "";
  save();
}

function renderList() {
  const list = document.getElementById("cardList");
  list.innerHTML = "";
  cards.forEach((c, i) => {
    const li = document.createElement("li");
    li.textContent = `${i+1}. ${c.front} → ${c.back}`;
    list.appendChild(li);
  });
}
renderList();

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function startReview() {
  if (!cards.length) return;
  queue = shuffle([...Array(cards.length).keys()]);
  lastChecked = false;
  nextCard();
  document.getElementById("cardArea").classList.remove("hidden");
  document.getElementById("answerInput").focus();
}

function nextCard() {
  if (!queue.length) return;
  current = queue.shift();
  const mode = document.getElementById("mode").value;
  currentSide = mode === "mixed" ? (Math.random()<0.5 ? "front":"back") : mode;
  document.getElementById("prompt").textContent = cards[current][currentSide];
  document.getElementById("answerInput").value = "";
  document.getElementById("result").innerHTML = "";
  lastChecked = false;
}

function normalize(s) {
  return s.trim().toLowerCase();
}

function checkAnswer() {
  if (current === null) return;
  const input = normalize(document.getElementById("answerInput").value);
  const expected = currentSide === "front" ? cards[current].back : cards[current].front;
  const answers = expected.split(/[,;/]/).map(a=>normalize(a));
  const correct = answers.includes(input);
  document.getElementById("result").innerHTML =
    `<div class="p-2 rounded ${correct?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">
      ${correct? '✅ Correct!':'❌ Not quite.'} Expected: <b>${expected}</b>
    </div>`;
  lastChecked = true;
}

function exportJSON() {
  const blob = new Blob([JSON.stringify(cards, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "flashcards.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importFromFile(e) {
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      if (Array.isArray(data)) {
        // Expect [{front, back}, ...]
        // Basic validation:
        const cleaned = data.filter(x => x && typeof x.front === "string" && typeof x.back === "string");
        if (cleaned.length) {
          cards = cleaned;
          save();
          alert(`Imported ${cleaned.length} cards.`);
        } else {
          alert("No valid cards found in JSON.");
        }
      } else {
        alert("JSON should be an array of {front, back} objects.");
      }
    } catch (err) {
      alert("Invalid JSON file.");
    }
    e.target.value = ""; // reset file input
  };
  reader.readAsText(file);
}

// ENTER key behavior: Enter = Check; if already checked, Enter = Next
document.getElementById("answerInput").addEventListener("keydown", (ev) => {
  if (ev.key === "Enter") {
    ev.preventDefault();
    if (!lastChecked) {
      checkAnswer();
    } else {
      nextCard();
    }
  }
});
</script>
</body>
</html>

